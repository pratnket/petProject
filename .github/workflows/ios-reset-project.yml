name: iOS Reset Project - é‡ç½®å°ˆæ¡ˆ

on:
  workflow_dispatch: # åªå…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  ios-reset-project:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Backup current iOS project
        run: |
          echo "ğŸ’¾ === å‚™ä»½ç•¶å‰ iOS å°ˆæ¡ˆ ==="
          cp -r ios ios_backup_$(date +%Y%m%d_%H%M%S)
          echo "âœ… å‚™ä»½å®Œæˆ"

      - name: Remove current iOS project
        run: |
          echo "ğŸ—‘ï¸ === ç§»é™¤ç•¶å‰ iOS å°ˆæ¡ˆ ==="
          rm -rf ios
          echo "âœ… iOS ç›®éŒ„å·²ç§»é™¤"

      - name: Generate new iOS project
        run: |
          echo "ğŸ”„ === ç”Ÿæˆæ–°çš„ iOS å°ˆæ¡ˆ ==="

          # ä½¿ç”¨ React Native CLI é‡æ–°ç”Ÿæˆ
          npx @react-native-community/cli init TempProject --skip-install

          # ç§»å‹•æ–°ç”Ÿæˆçš„ iOS ç›®éŒ„
          mv TempProject/ios ios

          # æ¸…ç†è‡¨æ™‚ç›®éŒ„
          rm -rf TempProject

          echo "âœ… æ–° iOS å°ˆæ¡ˆå·²ç”Ÿæˆ"

      - name: Verify new iOS project
        run: |
          echo "ğŸ” === é©—è­‰æ–° iOS å°ˆæ¡ˆ ==="

          echo "ğŸ“± iOS ç›®éŒ„å…§å®¹ï¼š"
          ls -la ios/
          echo ""

          echo "ğŸ“‹ Podfile å…§å®¹ï¼š"
          cat ios/Podfile
          echo ""

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ === å®‰è£ä¾è³´ ==="

          # å®‰è£ Node.js ä¾è³´
          yarn install --frozen-lockfile

          # å®‰è£ iOS ä¾è³´
          cd ios
          pod install

      - name: Test new project build
        run: |
          cd ios
          echo "ğŸ”¨ === æ¸¬è©¦æ–°å°ˆæ¡ˆæ§‹å»º ==="

          # æ¸¬è©¦æ§‹å»º
          xcodebuild -project PetProject.xcodeproj \
                     -scheme PetProject \
                     -configuration Debug \
                     -destination 'generic/platform=iOS Simulator' \
                     build

      - name: Success notification
        if: success()
        run: |
          echo "ğŸ‰ iOS å°ˆæ¡ˆé‡ç½®æˆåŠŸï¼"
          echo "âœ… æ–°å°ˆæ¡ˆæ§‹å»ºæˆåŠŸ"
          echo "ğŸ’¡ å•é¡Œå·²è§£æ±º"

      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ æ–°å°ˆæ¡ˆä»ç„¶å¤±æ•—"
          echo "ğŸ” éœ€è¦é€²ä¸€æ­¥åˆ†æ"
          echo "ğŸ’¡ å¯èƒ½æ˜¯ React Native ç‰ˆæœ¬å•é¡Œ"
